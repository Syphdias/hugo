---
layout: post
date: 2012-09-23 00:22:00 +02:00
title: "systemd: modify IO scheduling"
---
<p>
One of the nice things about systemd is that you can change the Nice level and
IO scheduling class/priority in a very simple way. I have recently configured
<code>bacula-fd</code> on my server in such a way that it will not put a lot of
load on the machine:
</p>

<pre>
$ sudo systemctl enable bacula-fd.service
Created symlink /etc/systemd/system/multi-user.target.wants/bacula-fd.service → /usr/lib/systemd/system/bacula-fd.service.
</pre>

<p>
Should this fail for you, you can also just link or copy the unit file by hand.
</p>

<p>
Then, add an override for the service unit by doing the following:
</p>

<pre>
$ sudo systemctl edit bacula-fd.service
</pre>

<p>
This will open an editor to add additions to the service unit. depending on your
systemd version you might not see the commented out options of the current unit.
After adding the options it might look something like this:
</p>

<pre>
### Editing /etc/systemd/system/bacula-fd.service.d/override.conf
### Anything between here and the comment below will become the new contents of the file
<strong>[Service]
Nice=10
IOSchedulingClass=best-effort
IOSchedulingPriority=7</strong>

### Lines below this comment will be discarded

### /usr/lib/systemd/system/bacula-fd.service
# [Unit]
# Description=Bacula File Daemon service
# Documentation=man:bacula-fd(8)
# Requires=network.target
# After=network.target
# RequiresMountsFor=/var/lib/bacula /etc/bacula /usr/sbin
#
# # from http://www.freedesktop.org/software/systemd/man/systemd.service.html
# [Service]
# Type=exec
# User=root
# Group=root
# Environment="CONFIG=/etc/bacula/bacula-fd.conf"
# EnvironmentFile=-/etc/default/bacula-fd
# ExecStartPre=/usr/sbin/bacula-fd -t -c $CONFIG
# ExecStart=/usr/sbin/bacula-fd -fP -c $CONFIG
# ExecReload=/usr/sbin/bacula-fd -t -c $CONFIG
# ExecReload=/bin/kill -HUP $MAINPID
# SuccessExitStatus=15
# Restart=on-failure
# RestartSec=60
#
# [Install]
# WantedBy=multi-user.target
</pre>

<p>
And that’s it. See <code>nice(1)</code> and <code>ionice(1)</code> for the
possible values. Of course, these attributes are passed on to child processs:
</p>

<pre>
USER       PID PRI  NI %CPU %MEM COMMAND
root      3522  30  10  0.0  0.0 /usr/sbin/bacula-fd -u root -g root -c /etc/bacula/bacula-fd.conf
root     23380  30  10  0.0  0.0  \_ /bin/sh /root/bin/xen-lvm-snapshot/foreach-domu.sh mount
root     23607  30  10  0.0  0.0      \_ /bin/sh /root/bin/xen-lvm-snapshot/mount-snapshot.sh plana/domu-web
root     23665  30  10  0.0  0.0          \_ /sbin/fsck.ext3 -y /dev/loop3
</pre>
